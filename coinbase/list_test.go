// Copyright (c) 2023 BVK Chaitanya

package coinbase

import (
	"encoding/json"
	"strings"
	"testing"
)

func TestListOrdersResponse(t *testing.T) {
	var body string = `
{"orders":[{"order_id":"b7c2ea1c-47b4-4dac-90b5-4b124f36386e", "product_id":"BCH-USD", "user_id":"4f1613ca-502a-5a8f-90e6-1fe6ccfc6a06", "order_configuration":{"limit_limit_gtc":{"base_size":"1", "limit_price":"234.69", "post_only":false}}, "side":"SELL", "client_order_id":"32100f9c-6814-429f-e6db-fc95b89a5fb4", "status":"FILLED", "time_in_force":"GOOD_UNTIL_CANCELLED", "created_time":"2023-11-15T03:10:54.207879Z", "completion_percentage":"100.00", "filled_size":"1", "average_filled_price":"234.69", "fee":"", "number_of_fills":"2", "filled_value":"234.69", "pending_cancel":false, "size_in_quote":false, "total_fees":"0.586725", "size_inclusive_of_fees":false, "total_value_after_fees":"234.103275", "trigger_status":"INVALID_ORDER_TYPE", "order_type":"LIMIT", "reject_reason":"REJECT_REASON_UNSPECIFIED", "settled":true, "product_type":"SPOT", "reject_message":"", "cancel_message":"", "order_placement_source":"RETAIL_ADVANCED", "outstanding_hold_amount":"0", "is_liquidation":false, "last_fill_time":"2023-11-15T11:59:26.169883Z", "edit_history":[], "leverage":"", "margin_type":"UNKNOWN_MARGIN_TYPE"}, {"order_id":"e96c8b61-3207-4c67-b632-28147d0bfea6", "product_id":"BCH-USD", "user_id":"4f1613ca-502a-5a8f-90e6-1fe6ccfc6a06", "order_configuration":{"limit_limit_gtc":{"base_size":"1", "limit_price":"233.69", "post_only":false}}, "side":"SELL", "client_order_id":"d4f338ad-ac0c-a227-a7b4-880534a27959", "status":"FILLED", "time_in_force":"GOOD_UNTIL_CANCELLED", "created_time":"2023-11-15T03:10:54.110447Z", "completion_percentage":"100.00", "filled_size":"1", "average_filled_price":"233.69", "fee":"", "number_of_fills":"1", "filled_value":"233.69", "pending_cancel":false, "size_in_quote":false, "total_fees":"0.584225", "size_inclusive_of_fees":false, "total_value_after_fees":"233.105775", "trigger_status":"INVALID_ORDER_TYPE", "order_type":"LIMIT", "reject_reason":"REJECT_REASON_UNSPECIFIED", "settled":true, "product_type":"SPOT", "reject_message":"", "cancel_message":"", "order_placement_source":"RETAIL_ADVANCED", "outstanding_hold_amount":"0", "is_liquidation":false, "last_fill_time":"2023-11-15T11:55:20.673Z", "edit_history":[], "leverage":"", "margin_type":"UNKNOWN_MARGIN_TYPE"}, {"order_id":"dbbdba02-cea5-4066-83cf-ce1044549794", "product_id":"BCH-USD", "user_id":"4f1613ca-502a-5a8f-90e6-1fe6ccfc6a06", "order_configuration":{"limit_limit_gtc":{"base_size":"1", "limit_price":"226.67", "post_only":false}}, "side":"SELL", "client_order_id":"ffc33c5a-7195-cbb2-5beb-a0998c1dbf58", "status":"FILLED", "time_in_force":"GOOD_UNTIL_CANCELLED", "created_time":"2023-11-14T18:53:57.202150Z", "completion_percentage":"100.00", "filled_size":"1", "average_filled_price":"226.67", "fee":"", "number_of_fills":"1", "filled_value":"226.67", "pending_cancel":false, "size_in_quote":false, "total_fees":"0.566675", "size_inclusive_of_fees":false, "total_value_after_fees":"226.103325", "trigger_status":"INVALID_ORDER_TYPE", "order_type":"LIMIT", "reject_reason":"REJECT_REASON_UNSPECIFIED", "settled":true, "product_type":"SPOT", "reject_message":"", "cancel_message":"", "order_placement_source":"RETAIL_ADVANCED", "outstanding_hold_amount":"0", "is_liquidation":false, "last_fill_time":"2023-11-14T18:57:36.921Z", "edit_history":[], "leverage":"", "margin_type":"UNKNOWN_MARGIN_TYPE"}, {"order_id":"daf61c64-1290-412e-9956-7babf4e00280", "product_id":"BCH-USD", "user_id":"4f1613ca-502a-5a8f-90e6-1fe6ccfc6a06", "order_configuration":{"limit_limit_gtc":{"base_size":"1", "limit_price":"227.67", "post_only":false}}, "side":"SELL", "client_order_id":"f1ede6ba-2fc2-be90-8909-e1aae9300494", "status":"FILLED", "time_in_force":"GOOD_UNTIL_CANCELLED", "created_time":"2023-11-14T18:53:55.778676Z", "completion_percentage":"100.00", "filled_size":"1", "average_filled_price":"227.67", "fee":"", "number_of_fills":"2", "filled_value":"227.67", "pending_cancel":false, "size_in_quote":false, "total_fees":"0.569175", "size_inclusive_of_fees":false, "total_value_after_fees":"227.100825", "trigger_status":"INVALID_ORDER_TYPE", "order_type":"LIMIT", "reject_reason":"REJECT_REASON_UNSPECIFIED", "settled":true, "product_type":"SPOT", "reject_message":"", "cancel_message":"", "order_placement_source":"RETAIL_ADVANCED", "outstanding_hold_amount":"0", "is_liquidation":false, "last_fill_time":"2023-11-14T19:06:04.033087Z", "edit_history":[], "leverage":"", "margin_type":"UNKNOWN_MARGIN_TYPE"}, {"order_id":"2e021151-8818-4ee3-993f-ef78cca8000b", "product_id":"BCH-USD", "user_id":"4f1613ca-502a-5a8f-90e6-1fe6ccfc6a06", "order_configuration":{"limit_limit_gtc":{"base_size":"1", "limit_price":"228.67", "post_only":false}}, "side":"SELL", "client_order_id":"03168e30-7f86-bc3a-22c9-e37617b66058", "status":"FILLED", "time_in_force":"GOOD_UNTIL_CANCELLED", "created_time":"2023-11-14T18:53:52.735486Z", "completion_percentage":"100.00", "filled_size":"1", "average_filled_price":"228.67", "fee":"", "number_of_fills":"2", "filled_value":"228.67", "pending_cancel":false, "size_in_quote":false, "total_fees":"0.571675", "size_inclusive_of_fees":false, "total_value_after_fees":"228.098325", "trigger_status":"INVALID_ORDER_TYPE", "order_type":"LIMIT", "reject_reason":"REJECT_REASON_UNSPECIFIED", "settled":true, "product_type":"SPOT", "reject_message":"", "cancel_message":"", "order_placement_source":"RETAIL_ADVANCED", "outstanding_hold_amount":"0", "is_liquidation":false, "last_fill_time":"2023-11-14T19:09:48.280214Z", "edit_history":[], "leverage":"", "margin_type":"UNKNOWN_MARGIN_TYPE"}, {"order_id":"6f91792b-2f30-4108-a499-618662a7e713", "product_id":"BCH-USD", "user_id":"4f1613ca-502a-5a8f-90e6-1fe6ccfc6a06", "order_configuration":{"limit_limit_gtc":{"base_size":"1", "limit_price":"229.67", "post_only":false}}, "side":"SELL", "client_order_id":"d4f99980-581f-8c99-a51d-8ec1fe493051", "status":"FILLED", "time_in_force":"GOOD_UNTIL_CANCELLED", "created_time":"2023-11-14T18:53:51.162063Z", "completion_percentage":"100.00", "filled_size":"1", "average_filled_price":"229.67", "fee":"", "number_of_fills":"1", "filled_value":"229.67", "pending_cancel":false, "size_in_quote":false, "total_fees":"0.574175", "size_inclusive_of_fees":false, "total_value_after_fees":"229.095825", "trigger_status":"INVALID_ORDER_TYPE", "order_type":"LIMIT", "reject_reason":"REJECT_REASON_UNSPECIFIED", "settled":true, "product_type":"SPOT", "reject_message":"", "cancel_message":"", "order_placement_source":"RETAIL_ADVANCED", "outstanding_hold_amount":"0", "is_liquidation":false, "last_fill_time":"2023-11-14T20:17:41.732Z", "edit_history":[], "leverage":"", "margin_type":"UNKNOWN_MARGIN_TYPE"}, {"order_id":"abfe7e41-9e2b-4814-b8ab-f1140c67f9ed", "product_id":"BCH-USD", "user_id":"4f1613ca-502a-5a8f-90e6-1fe6ccfc6a06", "order_configuration":{"limit_limit_gtc":{"base_size":"1", "limit_price":"230.68", "post_only":false}}, "side":"SELL", "client_order_id":"fd76dd87-c066-d2db-60ec-32cf5850021d", "status":"FILLED", "time_in_force":"GOOD_UNTIL_CANCELLED", "created_time":"2023-11-14T18:53:47.307986Z", "completion_percentage":"100.00", "filled_size":"1", "average_filled_price":"230.68", "fee":"", "number_of_fills":"1", "filled_value":"230.68", "pending_cancel":false, "size_in_quote":false, "total_fees":"0.5767", "size_inclusive_of_fees":false, "total_value_after_fees":"230.1033", "trigger_status":"INVALID_ORDER_TYPE", "order_type":"LIMIT", "reject_reason":"REJECT_REASON_UNSPECIFIED", "settled":true, "product_type":"SPOT", "reject_message":"", "cancel_message":"", "order_placement_source":"RETAIL_ADVANCED", "outstanding_hold_amount":"0", "is_liquidation":false, "last_fill_time":"2023-11-14T21:52:19.442Z", "edit_history":[], "leverage":"", "margin_type":"UNKNOWN_MARGIN_TYPE"}, {"order_id":"497fdbda-b032-4c99-be05-3ff85cc8e504", "product_id":"BCH-USD", "user_id":"4f1613ca-502a-5a8f-90e6-1fe6ccfc6a06", "order_configuration":{"limit_limit_gtc":{"base_size":"1", "limit_price":"231.68", "post_only":false}}, "side":"SELL", "client_order_id":"2e6a23f6-6578-6acb-a3d5-016adafd7fa5", "status":"FILLED", "time_in_force":"GOOD_UNTIL_CANCELLED", "created_time":"2023-11-14T18:52:05.179966Z", "completion_percentage":"100.00", "filled_size":"1", "average_filled_price":"231.68", "fee":"", "number_of_fills":"2", "filled_value":"231.68", "pending_cancel":false, "size_in_quote":false, "total_fees":"0.5792", "size_inclusive_of_fees":false, "total_value_after_fees":"231.1008", "trigger_status":"INVALID_ORDER_TYPE", "order_type":"LIMIT", "reject_reason":"REJECT_REASON_UNSPECIFIED", "settled":true, "product_type":"SPOT", "reject_message":"", "cancel_message":"", "order_placement_source":"RETAIL_ADVANCED", "outstanding_hold_amount":"0", "is_liquidation":false, "last_fill_time":"2023-11-14T22:57:26.577Z", "edit_history":[], "leverage":"", "margin_type":"UNKNOWN_MARGIN_TYPE"}, {"order_id":"f29f51cc-b96b-4a30-9e57-8f4c36349e5c", "product_id":"BCH-USD", "user_id":"4f1613ca-502a-5a8f-90e6-1fe6ccfc6a06", "order_configuration":{"limit_limit_gtc":{"base_size":"1", "limit_price":"232.68", "post_only":false}}, "side":"SELL", "client_order_id":"ef4b3af2-dc20-1a94-8820-91aca785bc16", "status":"FILLED", "time_in_force":"GOOD_UNTIL_CANCELLED", "created_time":"2023-11-14T18:51:53.930732Z", "completion_percentage":"100.00", "filled_size":"1", "average_filled_price":"232.68", "fee":"", "number_of_fills":"1", "filled_value":"232.68", "pending_cancel":false, "size_in_quote":false, "total_fees":"0.5817", "size_inclusive_of_fees":false, "total_value_after_fees":"232.0983", "trigger_status":"INVALID_ORDER_TYPE", "order_type":"LIMIT", "reject_reason":"REJECT_REASON_UNSPECIFIED", "settled":true, "product_type":"SPOT", "reject_message":"", "cancel_message":"", "order_placement_source":"RETAIL_ADVANCED", "outstanding_hold_amount":"0", "is_liquidation":false, "last_fill_time":"2023-11-15T00:25:26.534Z", "edit_history":[], "leverage":"", "margin_type":"UNKNOWN_MARGIN_TYPE"}], "sequence":"0", "has_next":false, "cursor":""}
`
	v := new(ListOrdersResponse)
	if err := json.Unmarshal([]byte(strings.TrimSpace(body)), v); err != nil {
		t.Fatal(err)
	}
}

func TestListProducts(t *testing.T) {
	if !checkCredentials() {
		t.Skip("no credentials")
		return
	}

	c, err := New(testingKey, testingSecret, testingOptions)
	if err != nil {
		t.Fatal(err)
	}
	defer func() {
		if err := c.Close(); err != nil {
			t.Fatal(err)
		}
	}()

	ps, err := c.listProducts(c.ctx)
	if err != nil {
		t.Fatal(err)
	}
	t.Logf("list products: %#v", ps)
}
